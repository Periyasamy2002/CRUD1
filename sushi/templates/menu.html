{% extends "base.html" %}
{% load static %}
{% block title %}Menu – Sushi Naruto{% endblock %}

{% block content %}
<style>
    /* Fade-in animation */
    .fade-in {
        opacity: 0;
        transform: translateY(20px);
        animation: fadeInUp 0.6s ease-out forwards;
    }

    @keyframes fadeInUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    h1,
    h2 {
        font-family: 'Arial', sans-serif;
        margin-top: 30px;
    }

    .menu-category-container {
        margin-bottom: 2.5rem;
        scroll-margin-top: 100px;
    }

    .menu-category-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #b91c1c;
        margin-bottom: 1rem;
        margin-top: 2rem;
    }

    .menu-cards {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
    }

    .menu-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.07);
        padding: 1.2rem;
        width: 270px;
        display: flex;
        flex-direction: column;
        align-items: center;
        transition: box-shadow 0.2s;
    }

    .menu-card:hover {
        box-shadow: 0 6px 24px rgba(0, 0, 0, 0.13);
    }

    .menu-card img {
        border-radius: 8px;
        width: 100%;
        max-width: 180px;
        max-height: 120px;
        object-fit: cover;
        margin-bottom: 0.8rem;
    }

    .menu-card-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.4rem;
        color: #222;
        text-align: center;
    }

    .menu-card-desc {
        font-size: 0.97rem;
        color: #555;
        margin-bottom: 0.6rem;
        text-align: center;
        min-height: 40px;
    }

    .menu-card-price {
        font-weight: bold;
        color: #388E3C;
        font-size: 1.05rem;
        margin-bottom: 0.2rem;
    }

    .tab-active {
        @apply bg-red-600 text-white;
    }

    .tab-inactive {
        @apply bg-gray-100 text-gray-700 hover:bg-gray-200;
    }

    .modal-fade {
        transition: opacity 0.2s;
    }
</style>

<!-- Hero Section -->
<div class="fade-in flex flex-col md:flex-row items-center mb-8">
    <img src="{% static 'images/menu_hero.jpg' %}" alt="Sushi Naruto Menu"
        class="rounded-lg shadow-lg w-full max-w-xs mr-6 mb-4 md:mb-0">
    <div>
        <h1 class="text-3xl font-bold text-red-700 mb-2">Menu of Sushi Naruto</h1>
        <p class="text-lg text-gray-700">Discover our chef’s selection of authentic Japanese sushi, Asian specialties,
            and vegetarian delights. All dishes are freshly prepared with premium ingredients.</p>
    </div>
</div>

<!-- Chef's Recommendation -->
<div class="fade-in bg-yellow-50 border-l-4 border-red-400 p-4 mb-8">
    <h2 class="text-xl font-semibold text-red-600 mb-2">Chef's Recommendation</h2>
    <ul class="list-disc ml-6">
        <li>Signature Naruto Roll – Salmon, avocado, spicy mayo</li>
        <li>Dragon Maki – Tempura shrimp, avocado, eel sauce</li>
        <li>Vegetarian Ikebana Plate – Assorted veggie maki & nigiri</li>
    </ul>
</div>
<nav class="bg-white shadow mb-6">
    <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
        <h1 class="text-xl font-bold text-center md:text-left">SUSHI NARUTO MOMOS AND MORE Menu</h1>
        <div class="flex items-center gap-4 w-full md:w-auto">
            <!-- Search Bar -->
            <div class="relative flex-grow">
                <input type="text" id="menuSearchInput" placeholder="Search menu..."
                    class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-400">
                <div class="absolute top-0 left-0 inline-flex items-center justify-center w-10 h-full text-gray-400">
                    <svg class="h-5 w-5" fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
                <!-- Search results dropdown -->
                <div id="searchResultsDropdown"
                    class="absolute top-full left-0 w-full mt-1 bg-white border rounded-lg shadow-lg z-20 hidden max-h-80 overflow-y-auto">
                    <!-- Search results will be injected here by JavaScript -->
                </div>
            </div>
            <!-- View Button -->
            <div class="relative">
                <button id="categoryButton" class="flex items-center justify-center px-4 py-2 border rounded-lg text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-red-400">
                    Categories
                    <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="categoryDropdown"
                    class="absolute right-0 mt-2 w-56 bg-white border rounded shadow-md hidden z-10">
                    <div class="px-4 py-2 font-semibold text-gray-700 border-b">Categories</div>
                    <ul class="text-sm text-gray-700">
                        {% for category in categories %}
                        <li class="px-4 py-2 hover:bg-gray-100 cursor-pointer flex items-center space-x-2"
                            data-category="{{ category.name|slugify }}">
                            <span>{{ category.name }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
<!-- Wrap menu and modal in a single Alpine.js scope -->
<div x-data="orderModal()" x-cloak>
    {# Menu Items by Category #}
    <div>
        {% regroup menuitems by category as category_list %}
        {% for cat in category_list %}
        <div class="menu-category-container fade-in" id="category-{{ cat.grouper.name|slugify }}">
            <div class="menu-category-title">{{ cat.grouper.name }}</div>
            <div class="menu-cards">
                {% for item in cat.list %}
                <div class="menu-card" id="menu-item-{{ item.id }}">
                    {% if item.image %}
                    <img src="{{ item.image.url }}" alt="{{ item.name }}"
                        class="cursor-pointer"
                        @click="openOrderModal('{{ item.name|escapejs }}', {{ item.price }})">
                    {% else %}
                    <img src="{% static 'images/no-image.png' %}" alt="No image"
                        class="cursor-pointer"
                        @click="openOrderModal('{{ item.name|escapejs }}', {{ item.price }})">
                    {% endif %}
                    <div class="menu-card-title">{{ item.name }}</div>
                    <div class="menu-card-desc">{{ item.description }}</div>
                    <div class="menu-card-price">{{ item.price }} CHF</div>
                    <!-- Order Button -->
                    <button class="mt-2 bg-red-600 text-white px-4 py-1 rounded hover:bg-red-700 transition"
                        @click="openOrderModal('{{ item.name|escapejs }}', {{ item.price }})">
                        Order
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>
        {% empty %}
        <p>No menu items available.</p>
        {% endfor %}
    </div>

    <!-- 3-step modal -->
    <div x-show="open" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 modal-fade"
        x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-150"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        aria-modal="true" role="dialog">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative" @click.away="reset" @keydown.escape.window="reset">
            <button class="absolute top-2 right-2 text-gray-400 hover:text-red-600 text-2xl" @click="reset" aria-label="Close">&times;</button>
            <h2 class="text-lg font-bold mb-4 text-center">Order: <span x-text="itemName"></span></h2>
            <!-- Step 1: Cart Review -->
            <template x-if="step === 1">
                <div>
                    <div class="mb-4">
                        <label class="block font-semibold mb-1">Quantity</label>
                        <div class="flex items-center">
                            <button class="px-3 py-1 bg-gray-200 rounded-l" @click="qty = Math.max(1, qty-1)">-</button>
                            <span class="px-4" x-text="qty"></span>
                            <button class="px-3 py-1 bg-gray-200 rounded-r" @click="qty++">+</button>
                        </div>
                    </div>
                    <div class="mb-4">Total: <span class="font-bold" x-text="(qty * price).toFixed(2)"></span> CHF</div>
                    <button class="bg-blue-600 text-white px-4 py-2 rounded w-full" @click="nextStep()">Next</button>
                </div>
            </template>
            <!-- Step 2: User Info & Delivery -->
            <template x-if="step === 2">
                <div>
                    <div class="mb-4">
                        <label class="block font-semibold mb-1">Email</label>
                        <input type="email" x-model="email" class="border rounded px-2 py-1 w-full" placeholder="Email">
                    </div>
                    <div class="mb-4">
                        <label class="block font-semibold mb-1">Mobile Number</label>
                        <input type="tel" x-model="mobile" class="border rounded px-2 py-1 w-full" placeholder="Mobile Number">
                    </div>
                    <div class="mb-4">
                        <label class="block font-semibold mb-1">Address</label>
                        <input type="text" x-model="address" class="border rounded px-2 py-1 w-full" placeholder="Address">
                    </div>
                    <div class="mb-4">
                        <label class="block font-semibold mb-1">Delivery Method</label>
                        <select x-model="delivery" class="border rounded px-2 py-1 w-full">
                            <option value="Click & Collect">Click & Collect (Free)</option>
                            <option value="Free">Free</option>
                            <option value="Livraison Express 3.5km">Livraison Express 3.5km</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block font-semibold mb-1">Order Type</label>
                        <select x-model="orderType" class="border rounded px-2 py-1 w-full">
                            <option value="now">Order Now (Live)</option>
                            <option value="later">Order Later (Schedule)</option>
                        </select>
                    </div>
                    <template x-if="orderType==='later'">
                        <div>
                            <div class="mb-3">
                                <label class="block font-semibold mb-1">Pick Date</label>
                                <input type="date" x-model="orderDate" class="border rounded px-2 py-1 w-full">
                            </div>
                            <div class="mb-3">
                                <label class="block font-semibold mb-1">Pick Time</label>
                                <input type="time" x-model="orderTime" class="border rounded px-2 py-1 w-full">
                            </div>
                        </div>
                    </template>
                    <template x-if="error">
                        <div class="text-red-600 mb-2" x-text="error"></div>
                    </template>
                    <div class="flex justify-between">
                        <button class="bg-gray-300 text-gray-700 px-4 py-2 rounded" @click="step=1">Back</button>
                        <button class="bg-green-600 text-white px-4 py-2 rounded" @click="validateAndNext()">Next</button>
                    </div>
                </div>
            </template>
            <!-- Step 3: Confirm & Place Order -->
            <template x-if="step === 3">
                <div>
                    <div class="mb-4">
                        <div><b>Item:</b> <span x-text="itemName"></span></div>
                        <div><b>Qty:</b> <span x-text="qty"></span></div>
                        <div><b>Total:</b> <span x-text="(qty * price).toFixed(2)"></span> CHF</div>
                        <div><b>Email:</b> <span x-text="email"></span></div>
                        <div><b>Mobile:</b> <span x-text="mobile"></span></div>
                        <div><b>Address:</b> <span x-text="address"></span></div>
                        <div><b>Delivery:</b> <span x-text="delivery"></span></div>
                        <div><b>Order Type:</b> <span x-text="orderType"></span></div>
                        <template x-if="orderType==='later'">
                            <div>
                                <div><b>Date:</b> <span x-text="orderDate"></span></div>
                                <div><b>Time:</b> <span x-text="orderTime"></span></div>
                            </div>
                        </template>
                    </div>
                    <template x-if="error">
                        <div class="text-red-600 mb-2" x-text="error"></div>
                    </template>
                    <button class="bg-blue-600 text-white px-4 py-2 rounded w-full" @click="submitOrder()" :disabled="loading">
                        <span x-show="!loading">Place Order</span>
                        <span x-show="loading" class="flex items-center justify-center">
                            <svg class="animate-spin h-5 w-5 mr-2 text-white" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"/></svg>
                            Processing...
                        </span>
                    </button>
                </div>
            </template>
            <!-- Success Message -->
            <template x-if="step === 4">
                <div class="text-center py-8">
                    <div class="text-green-600 text-4xl mb-2">✔</div>
                    <div class="font-semibold mb-2" x-text="successMsg"></div>
                    <button class="mt-2 px-4 py-2 bg-red-600 text-white rounded" @click="reset">Close</button>
                </div>
            </template>
        </div>
    </div>
</div>

<!-- Alpine.js for modal logic -->
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script>
function orderModal() {
    return {
        open: false,
        step: 1,
        itemName: '',
        price: 0,
        qty: 1,
        orderType: 'now',
        orderDate: '',
        orderTime: '',
        email: '',
        mobile: '',
        address: '',
        delivery: 'Click & Collect',
        loading: false,
        error: '',
        successMsg: 'Order placed successfully!',
        openOrderModal(name, price) {
            this.open = true;
            this.step = 1;
            this.itemName = name;
            this.price = price;
            this.qty = 1;
            this.orderType = 'now';
            this.orderDate = '';
            this.orderTime = '';
            this.email = '';
            this.mobile = '';
            this.address = '';
            this.delivery = 'Click & Collect';
            this.loading = false;
            this.error = '';
            this.successMsg = 'Order placed successfully!';
        },
        nextStep() {
            this.step = 2;
        },
        validateAndNext() {
            this.error = '';
            if (!this.email || !this.mobile || !this.address || !this.delivery) {
                this.error = 'Please fill all required fields.';
                return;
            }
            if (this.orderType === 'later' && (!this.orderDate || !this.orderTime)) {
                this.error = 'Please select both date and time.';
                return;
            }
            this.step = 3;
        },
        submitOrder() {
            this.error = '';
            this.loading = true;
            fetch('/order/submit/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': (document.querySelector('[name=csrfmiddlewaretoken]') || {}).value || ''
                },
                body: JSON.stringify({
                    item: this.itemName,
                    price: this.price,
                    qty: this.qty,
                    orderType: this.orderType,
                    orderDate: this.orderType === 'later' ? this.orderDate : null,
                    orderTime: this.orderType === 'later' ? this.orderTime : null,
                    email: this.email,
                    mobile: this.mobile,
                    address: this.address,
                    delivery: this.delivery
                })
            })
            .then(res => res.json())
            .then(data => {
                this.loading = false;
                if (data.success) {
                    this.successMsg = 'Order placed successfully!';
                    this.step = 4;
                } else {
                    this.error = data.error || 'Order failed. Try again.';
                }
            })
            .catch(() => {
                this.loading = false;
                this.error = 'Order failed. Try again.';
            });
        },
        reset() {
            this.open = false;
            this.step = 1;
            this.itemName = '';
            this.price = 0;
            this.qty = 1;
            this.orderType = 'now';
            this.orderDate = '';
            this.orderTime = '';
            this.email = '';
            this.mobile = '';
            this.address = '';
            this.delivery = 'Click & Collect';
            this.loading = false;
            this.error = '';
            this.successMsg = 'Order placed successfully!';
        }
    }
}

document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('menuSearchInput');
    const searchResultsDropdown = document.getElementById('searchResultsDropdown');

    searchInput.addEventListener('input', function () {
        const query = this.value.trim();

        if (query.length < 2) { // Start searching after 2 characters
            searchResultsDropdown.classList.add('hidden');
            return;
        }

        fetch(`/api/search_menu_items/?q=${query}`)
            .then(response => response.json())
            .then(data => {
                searchResultsDropdown.innerHTML = ''; // Clear previous results
                if (data.length > 0) {
                    data.forEach(item => {
                        const resultCard = document.createElement('a');
                        resultCard.href = item.url;
                        resultCard.classList.add('block', 'p-4', 'hover:bg-gray-100', 'border-b', 'cursor-pointer');
                        
                        let imageHtml = '';
                        if (item.image_url) {
                            imageHtml = `<img src="${item.image_url}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md mr-4">`;
                        } else {
                            imageHtml = `<div class="w-16 h-16 bg-gray-200 rounded-md mr-4"></div>`;
                        }

                        resultCard.innerHTML = `
                            <div class="flex items-center">
                                ${imageHtml}
                                <div>
                                    <div class="font-semibold text-gray-800">${item.name}</div>
                                    <div class="text-sm text-gray-600">${item.description}</div>
                                </div>
                            </div>
                        `;

                        resultCard.addEventListener('click', function(e) {
                            e.preventDefault();
                            const targetElement = document.querySelector(item.url);
                            if (targetElement) {
                                targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                // Highlight the card
                                targetElement.classList.add('transition', 'duration-500', 'ease-in-out', 'ring-2', 'ring-red-500', 'ring-offset-2');
                                setTimeout(() => {
                                    targetElement.classList.remove('ring-2', 'ring-red-500', 'ring-offset-2');
                                }, 2000);
                            }
                            searchResultsDropdown.classList.add('hidden');
                            searchInput.value = '';
                        });

                        searchResultsDropdown.appendChild(resultCard);
                    });
                    searchResultsDropdown.classList.remove('hidden');
                } else {
                    searchResultsDropdown.innerHTML = '<div class="p-4 text-gray-500">No results found.</div>';
                    searchResultsDropdown.classList.remove('hidden');
                }
            })
            .catch(error => {
                console.error('Error fetching search results:', error);
                searchResultsDropdown.classList.add('hidden');
            });
    });

    const categoryButton = document.getElementById('categoryButton');
    const categoryDropdown = document.getElementById('categoryDropdown');
    const categoryLinks = document.querySelectorAll('#categoryDropdown [data-category]');

    categoryButton.addEventListener('click', function(e) {
        e.stopPropagation();
        categoryDropdown.classList.toggle('hidden');
    });

    categoryLinks.forEach(link => {
        link.addEventListener('click', function() {
            const categorySlug = this.dataset.category;
            const categoryElement = document.getElementById(`category-${categorySlug}`);
            if (categoryElement) {
                categoryElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            categoryDropdown.classList.add('hidden');
        });
    });

    // Hide dropdowns when clicking outside
    document.addEventListener('click', function (e) {
        if (!searchInput.contains(e.target) && !searchResultsDropdown.contains(e.target)) {
            searchResultsDropdown.classList.add('hidden');
        }
        if (!categoryButton.contains(e.target) && !categoryDropdown.contains(e.target)) {
            categoryDropdown.classList.add('hidden');
        }
    });
});
</script>
{% endblock %}
