{% extends "admin2/base2.html" %}
{% block title %}Table Reservations - Admin{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-6 text-gray-800 flex items-center gap-2">
        <i class="fa-solid fa-utensils text-green-600"></i> Table Reservations
    </h1>

    <!-- Filters -->
    <div class="mb-6 flex flex-wrap gap-4 items-center">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-calendar-days text-gray-600"></i>
            <input type="date" id="dateFilter"
                class="rounded-md border-gray-300 shadow-sm focus:ring-green-400 focus:border-green-400">
        </div>
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-filter text-gray-600"></i>
            <select id="statusFilter"
                class="rounded-md border-gray-300 shadow-sm focus:ring-green-400 focus:border-green-400">
                <option value="">All Statuses</option>
                <option value="pending">Pending</option>
                <option value="confirmed">Confirmed</option>
                <option value="cancelled">Cancelled</option>
            </select>
        </div>
    </div>

    <!-- Table -->
    <div class="bg-white shadow-lg rounded-xl overflow-x-auto border border-gray-200">
        <table class="min-w-full divide-y divide-gray-200 text-sm">
            <thead class="bg-green-50 text-green-700">
                <tr>
                    <th class="px-6 py-3 text-left font-semibold uppercase tracking-wider">S.No</th>
                    <th class="px-6 py-3 text-left font-semibold uppercase tracking-wider">Submitted</th>
                    <th class="px-6 py-3 text-left font-semibold uppercase tracking-wider">Date & Time</th>
                    <th class="px-6 py-3 text-left font-semibold uppercase tracking-wider">Name</th>
                    <th class="px-6 py-3 text-left font-semibold uppercase tracking-wider">Contact</th>
                    <th class="px-6 py-3 text-left font-semibold uppercase tracking-wider">Guests</th>
                    <th class="px-6 py-3 text-left font-semibold uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left font-semibold uppercase tracking-wider">Actions</th>
                </tr>
            </thead>

            <tbody id="reservations-tbody" class="bg-white divide-y divide-gray-200">
                {% for reservation in reservations %}
                <tr class="hover:bg-gray-50 transition-all">
                    <td class="px-6 py-4 text-gray-500">{{ forloop.counter }}</td>
                    <td class="px-6 py-4 text-gray-600">{{ reservation.created_at|date:"Y-m-d H:i" }}</td>
                    <td class="px-6 py-4 text-gray-600">{{ reservation.date }} {{ reservation.time }}</td>
                    <td class="px-6 py-4 font-medium text-gray-900">{{ reservation.name }}</td>
                    <td class="px-6 py-4 text-gray-600">
                        <i class="fa-solid fa-envelope text-green-500"></i> {{ reservation.email }}<br>
                        <i class="fa-solid fa-phone text-blue-500"></i> {{ reservation.phone }}
                    </td>
                    <td class="px-6 py-4 text-gray-600">{{ reservation.guests }}</td>

                    <!-- Status -->
                    <td class="px-6 py-4">
                        <span class="px-3 py-1 rounded-full text-xs font-semibold 
                            {% if reservation.status == 'confirmed' %}
                                bg-green-100 text-green-800
                            {% elif reservation.status == 'cancelled' %}
                                bg-red-100 text-red-800
                            {% else %}
                                bg-yellow-100 text-yellow-800
                            {% endif %}
                        ">
                            {{ reservation.status|title }}
                        </span>
                    </td>

                    <!-- Actions -->
                    <td class="px-6 py-4 flex flex-wrap gap-2">

                        <!-- Change Status -->
                        <form method="post" action="{% url 'update_reservation_status' reservation.pk %}">
                            {% csrf_token %}
                            <select name="status" onchange="this.form.submit()"
                                class="rounded-md border-gray-300 text-sm shadow-sm focus:ring-green-400">
                                <option value="">Change</option>
                                <option value="confirmed">Confirm</option>
                                <option value="cancelled">Cancel</option>
                            </select>
                        </form>

                        <!-- View -->
                        <a href="{% url 'view_reservation' reservation.pk %}"
                            class="bg-indigo-100 hover:bg-indigo-200 text-indigo-700 font-semibold py-1 px-3 rounded-md flex items-center gap-1 transition">
                            <i class="fa-solid fa-eye"></i> View
                        </a>

                        <!-- Email -->
                        {% if reservation.status == 'confirmed' %}
                        <a href="#" 
                           data-to="{{ reservation.email }}"
                           data-subject="Reservation {{ reservation.pk }} Confirmed"
                           data-body="{% filter force_escape %}Dear {{ reservation.name }},

We are pleased to confirm your reservation for {{ reservation.date|date:'F j, Y' }} at {{ reservation.time|time:'g:i A' }} for {{ reservation.guests }} {% if reservation.guests == 1 %}guest{% else %}guests{% endif %}.

If you need to modify or cancel your booking, please reply to this email or contact us.

Thank you,
Sushi Restaurant{% endfilter %}"
                           onclick="openGmailFromData(this); return false;"
                           class="bg-green-100 hover:bg-green-200 text-green-700 font-semibold py-1 px-3 rounded-md flex items-center gap-1 transition">
                            <i class="fa-solid fa-envelope-circle-check"></i> Mail
                        </a>
                        {% elif reservation.status == 'cancelled' %}
                        <a href="#"
                           data-to="{{ reservation.email }}"
                           data-subject="Reservation {{ reservation.pk }} Cancelled"
                           data-body="{% filter force_escape %}Dear {{ reservation.name }},

We regret to inform you that your reservation for {{ reservation.date|date:'F j, Y' }} at {{ reservation.time|time:'g:i A' }} for {{ reservation.guests }} {% if reservation.guests == 1 %}guest{% else %}guests{% endif %} has been cancelled.

If you would like to reschedule or have any questions, please reply to this email or contact us.

Sincerely,
Sushi Restaurant{% endfilter %}"
                           onclick="openGmailFromData(this); return false;"
                           class="bg-red-100 hover:bg-red-200 text-red-700 font-semibold py-1 px-3 rounded-md flex items-center gap-1 transition">
                            <i class="fa-solid fa-envelope-open-text"></i> Mail
                        </a>
                        {% else %}
                        <span class="text-gray-400 text-sm italic">Pending...</span>
                        {% endif %}

                        <!-- Delete -->
                        <a href="{% url 'delete_reservation' reservation.pk %}"
                            class="bg-red-100 hover:bg-red-200 text-red-700 font-semibold py-1 px-3 rounded-md flex items-center gap-1 transition">
                            <i class="fa-solid fa-trash-can"></i> Delete
                        </a>
                    </td>
                </tr>

                {% empty %}
                <tr>
                    <td colspan="8" class="px-6 py-6 text-center text-gray-500">No reservations found</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- âœ… Scripts -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const dateFilter = document.getElementById('dateFilter');
        const statusFilter = document.getElementById('statusFilter');

        function applyFilters() {
            const params = new URLSearchParams();
            if (dateFilter.value) params.set('date', dateFilter.value);
            if (statusFilter.value) params.set('status', statusFilter.value);
            window.location.href = '?' + params.toString();
        }

        dateFilter.addEventListener('change', applyFilters);
        statusFilter.addEventListener('change', applyFilters);
        startRealtimeReservations();
    });

    async function refreshTbodyById(tbodyId) {
        try {
            const res = await fetch(window.location.href, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!res.ok) return;
            const html = await res.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newTbody = doc.querySelector('#' + tbodyId);
            if (newTbody) {
                const current = document.querySelector('#' + tbodyId);
                if (current && current.innerHTML !== newTbody.innerHTML) {
                    current.innerHTML = newTbody.innerHTML;
                }
            }
        } catch (e) {
            console.error('refreshTbodyById error:', e);
        }
    }

    function startRealtimeReservations() {
        const wsProtocol = (location.protocol === 'https:') ? 'wss:' : 'ws:';
        const wsUrl = wsProtocol + '//' + location.host + '/ws/admin/reservations/';
        let socket;
        try { socket = new WebSocket(wsUrl); } catch (e) { socket = null; }

        if (socket) {
            socket.addEventListener('message', () => refreshTbodyById('reservations-tbody'));
            socket.addEventListener('close', () => setInterval(() => refreshTbodyById('reservations-tbody'), 5000));
            socket.addEventListener('error', () => setInterval(() => refreshTbodyById('reservations-tbody'), 5000));
            setInterval(() => refreshTbodyById('reservations-tbody'), 15000);
        } else {
            setInterval(() => refreshTbodyById('reservations-tbody'), 5000);
        }
    }

    // Helper to open Gmail compose with prefilled fields from data- attributes
    function openGmailFromData(el) {
        try {
            const to = el.dataset.to || '';
            const subject = el.dataset.subject || '';
            const body = el.dataset.body || '';
            const url = 'https://mail.google.com/mail/?view=cm&to=' + encodeURIComponent(to)
                + '&su=' + encodeURIComponent(subject)
                + '&body=' + encodeURIComponent(body);
            window.open(url, '_blank', 'noopener');
        } catch (e) {
            console.error('openGmailFromData error:', e);
        }
    }
</script>

{% endblock %}