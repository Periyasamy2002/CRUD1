{% extends 'admin2/base2.html' %}
{% load static %}
{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="dashboard">
  <!-- ===== Header Section ===== -->
  <div class="dash-header">
    <h2 class="text-3xl font-bold text-gray-800">Admin Dashboard</h2>
    <div class="header-actions">
      <button id="refreshDashboard" class="btn-refresh">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 4l16 16"></path></svg>
        Refresh
      </button>
      <div class="relative">
        <input type="text" id="searchOrders" placeholder="Search orders..." class="search-input">
        <svg class="w-5 h-5 absolute top-1/2 right-3 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
      </div>
      <button id="exportCSV" class="btn-export">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
        Export CSV
      </button>
    </div>
  </div>

  <!-- ===== Overview Cards ===== -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
    <div class="card">
      <div class="card-icon bg-blue-500">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
      </div>
      <div class="meta">
        <span class="label">Total Orders</span>
        <span class="value" id="totalOrders">{{ total_orders|default:"0" }}</span>
      </div>
    </div>
    <div class="card">
      <div class="card-icon bg-green-500">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01"></path></svg>
      </div>
      <div class="meta">
        <span class="label">Total Revenue</span>
        <span class="value" id="totalRevenue">₹{{ total_revenue|default:"0.00" }}</span>
      </div>
    </div>
    <div class="card">
      <div class="card-icon bg-yellow-500">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
      </div>
      <div class="meta">
        <span class="label">Pending Orders</span>
        <span class="value" id="pendingOrders">{{ pending_orders|default:"0" }}</span>
      </div>
    </div>
    <div class="card">
      <div class="card-icon bg-red-500">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 0l-3.536 3.536m3.536-3.536l3.536 3.536m-3.536-3.536l-3.536-3.536m6.364 10.636l-3.536-3.536m0 0l-3.536-3.536m3.536 3.536l3.536-3.536m-3.536 3.536l-3.536 3.536"></path></svg>
      </div>
      <div class="meta">
        <span class="label">Delivered Orders</span>
        <span class="value" id="deliveredOrders">{{ delivered_orders|default:"0" }}</span>
      </div>
    </div>
  </div>

  <!-- ===== Charts + Recent Orders ===== -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
    <div class="lg:col-span-2 panel">
      <h3 class="text-xl font-semibold mb-4">Monthly Revenue</h3>
      <canvas id="revenueChart"></canvas>
    </div>

    <div class="panel recent-orders">
      <h3 class="text-xl font-semibold mb-4">Recent Orders</h3>
      <div class="overflow-x-auto">
        <table id="ordersTable" class="w-full">
          <thead>
            <tr>
              <th class="text-left">ID</th>
              <th class="text-left">Customer</th>
              <th class="text-left">Total</th>
              <th class="text-left">Status</th>
              <th class="text-left">Date</th>
            </tr>
          </thead>
          <tbody>
            {% for order in recent_orders %}
            <tr>
              <td>{{ order.id }}</td>
              <td>{{ order.customer_name }}</td>
              <td>₹{{ order.total_amount }}</td>
              <td><span class="status {{ order.status|lower }}">{{ order.status }}</span></td>
              <td>{{ order.created_at|date:"Y-m-d" }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="5" class="text-center text-muted py-4">No recent orders</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===== Extra Dashboard Sections ===== -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-6">
    <div class="panel">
      <h3 class="text-xl font-semibold mb-4">Top Selling Products</h3>
      <ul id="topProducts" class="space-y-2">
        {% for product in top_products %}
        <li>{{ product.name }} — <span class="font-semibold">{{ product.sales }} sold</span></li>
        {% empty %}
        <li class="text-gray-500">No data available</li>
        {% endfor %}
      </ul>
    </div>

    <div class="panel feedback">
      <h3 class="text-xl font-semibold mb-4">Customer Feedback</h3>
      <ul id="feedbackList" class="space-y-4">
        {% for fb in recent_feedback %}
        <li>
          <p class="italic">“{{ fb.message }}”</p>
          <small class="text-gray-500">- {{ fb.user_name }} ({{ fb.date|date:"Y-m-d" }})</small>
        </li>
        {% empty %}
        <li class="text-gray-500">No feedback yet</li>
        {% endfor %}
      </ul>
    </div>

    <div class="panel">
      <h3 class="text-xl font-semibold mb-4">Recent User Activity</h3>
      <ul id="userActivity" class="space-y-2">
        {% for log in user_logs %}
        <li>{{ log.user }} — {{ log.action }} <span class="text-gray-500">({{ log.timestamp|timesince }} ago)</span></li>
        {% empty %}
        <li class="text-gray-500">No user activity found</li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <!-- Loader -->
  <div id="loader" class="loader" aria-hidden="true" hidden>
    <div class="spinner" role="status" aria-hidden="true"></div>
    <p>Updating dashboard...</p>
  </div>
</div>

<!-- Small styling to improve visuals and smoothness -->
<style>
.dashboard { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
.card, .panel { background: #fff; border-radius: 10px; padding: 1rem; box-shadow: 0 6px 18px rgba(11, 22, 39, 0.06); transition: transform .18s ease, box-shadow .18s ease; }
.card:hover, .panel:hover { transform: translateY(-4px); box-shadow: 0 10px 30px rgba(11,22,39,0.08); }
.loader { position: fixed; right: 20px; bottom: 20px; background: rgba(255,255,255,0.96); border-radius: 8px; padding: .75rem 1rem; display:flex; align-items:center; gap:.6rem; box-shadow:0 6px 18px rgba(0,0,0,0.08); }
.spinner { width:18px; height:18px; border:3px solid rgba(0,0,0,0.08); border-top-color:#2563eb; border-radius:50%; animation: spin .9s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.search-input { padding:.5rem .9rem; border-radius:8px; border:1px solid #e5e7eb; width:240px; transition: box-shadow .12s ease; }
.search-input:focus { outline:none; box-shadow:0 6px 18px rgba(37,99,235,0.12); border-color:#3b82f6; }
.status { padding:.2rem .5rem; border-radius:999px; font-size:0.85rem; display:inline-block; }
.status.pending { background:#fff7ed; color:#92400e; }
.status.delivered { background:#ecfdf5; color:#065f46; }
.status.cancelled { background:#fff1f2; color:#7f1d1d; }
table tr { transition: background .12s ease, transform .12s ease; }
</style>

<!-- ===== Scripts ===== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const loader = document.getElementById("loader");
  const totalOrdersEl = document.getElementById("totalOrders");
  const totalRevenueEl = document.getElementById("totalRevenue");
  const pendingOrdersEl = document.getElementById("pendingOrders");
  const deliveredOrdersEl = document.getElementById("deliveredOrders");
  const ordersTableBody = document.getElementById("ordersTable").querySelector("tbody");
  const searchInput = document.getElementById("searchOrders");
  const exportBtn = document.getElementById("exportCSV");

  const toggleLoader = (show) => {
    if (show) { loader.hidden = false; loader.setAttribute("aria-hidden", "false"); }
    else { loader.hidden = true; loader.setAttribute("aria-hidden", "true"); }
  };

  // Initial data baked into template (fallback if API isn't available)
  const initialDashboard = {
    total_orders: Number("{{ total_orders|default:'0' }}") || 0,
    total_revenue: (function(s){
      // safely strip any non-numeric/decimal characters and parse
      const cleaned = String("{{ total_revenue|default:'0.00' }}").replace(/[^0-9\.\-]+/g, '');
      return Number(cleaned) || 0;
    })(),
    pending_orders: Number("{{ pending_orders|default:'0' }}") || 0,
    delivered_orders: Number("{{ delivered_orders|default:'0' }}") || 0,
    recent_orders: [
      {% for order in recent_orders %}
      {
        id: {{ order.id }},
        customer_name: "{{ order.customer_name|default:order.email|escapejs }}",
        total_amount: Number("{{ order.total_price|default:'0.00' }}"),
        status: "{{ order.status|title|escapejs }}",
        created_at: "{{ order.created_at|date:'Y-m-d H:i:s' }}"
      }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ],
    chart_data: {
      labels: {{ chart_data.labels|default:"[]"|safe }},
      values: {{ chart_data.values|default:"[]"|safe }}
    }
  };


  // Render to DOM
  function applyDashboard(data) {
    totalOrdersEl.textContent = data.total_orders;
    totalRevenueEl.textContent = "₹" + Number(data.total_revenue).toFixed(2);
    pendingOrdersEl.textContent = data.pending_orders;
    deliveredOrdersEl.textContent = data.delivered_orders;

    ordersTableBody.innerHTML = data.recent_orders.length
      ? data.recent_orders.map(order =>
        `<tr>
           <td>${order.id}</td>
           <td>${order.customer_name}</td>
           <td>₹${Number(order.total_amount).toFixed(2)}</td>
           <td><span class="status ${order.status.toLowerCase()}">${order.status}</span></td>
           <td>${order.created_at.split(' ')[0]}</td>
         </tr>`).join('')
      : `<tr><td colspan="5" class="text-center text-muted py-4">No recent orders</td></tr>`;

    renderChart(data.chart_data);
  }

  // Chart.js rendering
  let chartInstance;
  function renderChart(chartData) {
    const ctxEl = document.getElementById("revenueChart");
    if (!ctxEl) return;
    const ctx = ctxEl.getContext("2d");
    if (chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, {
      type: "line",
      data: {
        labels: chartData.labels || [],
        datasets: [{
          label: "Revenue (₹)",
          data: chartData.values || [],
          borderColor: "#10b981",
          backgroundColor: "rgba(16,185,129,0.12)",
          pointRadius: 3,
          tension: 0.35,
          fill: true
        }]
      },
      options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { ticks: { callback: v => '₹' + v } } } }
    });
  }

  // Try fetching live API but gracefully fallback to template-provided data
  async function fetchDashboardData() {
    toggleLoader(true);
    try {
      const res = await fetch("/admin/api/dashboard/");
      if (!res.ok) throw new Error("Live API not available");
      const data = await res.json();
      applyDashboard(data);
    } catch (err) {
      // fallback to initial data baked into template
      applyDashboard(initialDashboard);
    } finally {
      toggleLoader(false);
    }
  }

  // Debounced search for better UX
  function debounce(fn, wait) {
    let t;
    return function (...args) { clearTimeout(t); t = setTimeout(() => fn.apply(this, args), wait); };
  }
  searchInput.addEventListener("input", debounce(function () {
    const search = this.value.trim().toLowerCase();
    ordersTableBody.querySelectorAll("tr").forEach(row => {
      const visible = !search || row.textContent.toLowerCase().includes(search);
      row.style.display = visible ? "" : "none";
    });
  }, 180));

  // Improved CSV export (escape commas / quotes)
  exportBtn.addEventListener("click", () => {
    const rows = Array.from(ordersTableBody.querySelectorAll("tr"))
      .filter(r => r.style.display !== "none")
      .map(r => Array.from(r.children).map(td => {
        let txt = td.textContent.trim();
        if (txt.includes('"') || txt.includes(',')) txt = '"' + txt.replace(/"/g, '""') + '"';
        return txt;
      }).join(","));
    if (!rows.length) return alert("No rows to export");
    const csv = "Order ID,Customer,Total,Status,Date\n" + rows.join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "orders_report.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // Manual refresh
  document.getElementById("refreshDashboard").addEventListener("click", fetchDashboardData);

  // Auto-refresh every 5 min (but keep initial render immediately)
  applyDashboard(initialDashboard);
  setInterval(fetchDashboardData, 300000);



</script>
{% endblock %}
