{% extends 'admin2/base2.html' %}
{% load static %}
{% block title %}Admin Dashboard{% endblock %}

{% block content %}

<div class="dashboard" id="adminDashboard">
  <!-- ===== Header Section ===== -->
  <div class="dash-header">
    <h2 class="text-3xl font-bold text-gray-800">Admin Dashboard</h2>
    <div class="header-actions">
      <button id="refreshDashboard" class="btn-refresh">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 4l16 16"></path></svg>
        Refresh
      </button>
      <div class="relative">
        <input type="text" id="searchOrders" placeholder="Search orders..." class="search-input">
        <svg class="w-5 h-5 absolute top-1/2 right-3 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
      </div>
      <button id="exportCSV" class="btn-export">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
        Export CSV
      </button>

      <div class="notifications-container">
        {% include 'notifications/notifications_dropdown.html' with notifications=notifications %}
        <div id="notificationToast" class="notification-toast" hidden></div>
      </div>
    </div>
  </div>

  <!-- ===== Overview Cards ===== -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
    <div class="card">
      <div class="card-icon bg-blue-500">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
      </div>
      <div class="meta">
        <span class="label">Total Orders</span>
        <span class="value" id="totalOrders">
          {{ order_summary.total_orders|default:"0" }}
        </span>
      </div>
    </div>
    <div class="card">
      <div class="card-icon bg-green-500">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01"></path></svg>
      </div>
      <div class="meta">
        <span class="label">Total Revenue</span>
        <span class="value" id="totalRevenue">
          ₹{{ order_summary.total_revenue|floatformat:2|default:"0.00" }}
        </span>
      </div>
    </div>
    <div class="card">
      <div class="card-icon bg-yellow-500">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
      </div>
      <div class="meta">
        <span class="label">Pending Orders</span>
        <span class="value" id="pendingOrders">
          {{ order_summary.pending_orders|default:"0" }}
        </span>
      </div>
    </div>
    <div class="card">
      <div class="card-icon bg-red-500">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 0l-3.536 3.536m3.536-3.536l3.536 3.536m-3.536-3.536l-3.536-3.536m6.364 10.636l-3.536-3.536m0 0l-3.536-3.536m3.536 3.536l3.536-3.536m-3.536 3.536l-3.536 3.536"></path></svg>
      </div>
      <div class="meta">
        <span class="label">Delivered Orders</span>
        <span class="value" id="deliveredOrders">
          {{ order_summary.delivered_orders|default:"0" }}
        </span>
      </div>
    </div>
  </div>

  <!-- ===== Charts + Recent Orders ===== -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
    <div class="lg:col-span-2 panel">
      <h3 class="text-xl font-semibold mb-4">
        Monthly Revenue
        <span id="chartError" class="text-red-500 text-sm hidden">Failed to load chart data</span>
      </h3>
      <div class="chart-container" style="position: relative; height:300px;">
        <canvas id="revenueChart"></canvas>
        <div id="chartLoader" class="flex items-center justify-center absolute inset-0 bg-white/80">
          <div class="spinner"></div>
        </div>
      </div>
    </div>

    <div class="panel recent-orders">
      <h3 class="text-xl font-semibold mb-4">Recent Orders</h3>
      <div class="overflow-x-auto">
        <table id="ordersTable" class="w-full">
          <thead>
            <tr>
              <th class="text-left">ID</th>
              <th class="text-left">Customer</th>
              <th class="text-left">Items</th>
              <th class="text-left">Total</th>
              <th class="text-left">Status</th>
              <th class="text-left">Date</th>
            </tr>
          </thead>
          <tbody>
            {% for order in order_summary.recent_orders %}
            <tr>
              <td>{{ order.id }}</td>
              <td>{{ order.customer_name }}</td>
              <td>{{ order.item }}</td>
              <td>₹{{ order.total_amount|floatformat:2 }}</td>
              <td><span class="status {{ order.status|lower }}">{{ order.status }}</span></td>
              <td>{{ order.created_at|date:"d M Y H:i" }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="6" class="text-center text-muted py-4">No recent orders</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===== Extra Dashboard Sections ===== -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-6">
    <div class="panel">
      <h3 class="text-xl font-semibold mb-4">Top Selling Products</h3>
      <ul id="topProducts" class="space-y-2">
        {% for product in top_products %}
        <li>{{ product.name }} — <span class="font-semibold">{{ product.sales }} sold</span></li>
        {% empty %}
        <li class="text-gray-500">No data available</li>
        {% endfor %}
      </ul>
    </div>

    <div class="panel feedback">
      <h3 class="text-xl font-semibold mb-4">Customer Feedback</h3>
      <ul id="feedbackList" class="space-y-4">
        {% for fb in recent_feedback %}
        <li>
          <p class="italic">“{{ fb.message }}”</p>
          <small class="text-gray-500">- {{ fb.user_name }} ({{ fb.date|date:"Y-m-d" }})</small>
        </li>
        {% empty %}
        <li class="text-gray-500">No feedback yet</li>
        {% endfor %}
      </ul>
    </div>

    <div class="panel">
      <h3 class="text-xl font-semibold mb-4">Recent User Activity</h3>

      {# Online users summary (uses online_users_count or online_users queryset length if provided) #}
      <p class="mb-2 text-sm text-gray-600">Online users:
        <strong id="onlineUsers">
          {% if online_users_count|default_if_none:"" != "" %}{{ online_users_count }}
          {% elif online_users %}{{ online_users|length }}
          {% else %}0{% endif %}
        </strong>
      </p>

      <ul id="userActivity" class="space-y-2">
        {% for log in user_logs %}
        <li>
          {# show full name -> username -> raw user object/string #}
          {{ log.user.get_full_name|default:log.user.username|default:log.user }} — {{ log.action|default:"" }}
          {% if log.is_online or log.online or log.status == 'online' %}
            <span class="text-green-600 font-semibold ml-2">(online)</span>
          {% endif %}
          {% if log.timestamp %}
            <span class="text-gray-500"> ({{ log.timestamp|timesince }} ago)</span>
          {% else %}
            <span class="text-gray-500"> (just now)</span>
          {% endif %}
        </li>
        {% empty %}
        <li class="text-gray-500">No user activity found</li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <!-- Loader -->
  <div id="loader" class="loader" aria-hidden="true" hidden>
    <div class="spinner" role="status" aria-hidden="true"></div>
    <p>Updating dashboard...</p>
  </div>
</div>

<!-- Add debug info section (remove in production) -->
<div id="debugInfo" class="fixed top-0 right-0 bg-black/80 text-white p-4 m-4 rounded-lg text-sm" style="z-index: 9999;">
  <p>Raw Counts:</p>
  <pre>Orders: {{ total_orders_count|default:"N/A" }}
Users: {{ total_users_count|default:"N/A" }}
Revenue: {{ total_revenue|default:"N/A" }}</pre>
</div>

<!-- Small styling to improve visuals and smoothness -->
<style>
.dashboard { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
.card, .panel { background: #fff; border-radius: 10px; padding: 1rem; box-shadow: 0 6px 18px rgba(11, 22, 39, 0.06); transition: transform .18s ease, box-shadow .18s ease; }
.card:hover, .panel:hover { transform: translateY(-4px); box-shadow: 0 10px 30px rgba(11,22,39,0.08); }
.loader { position: fixed; right: 20px; bottom: 20px; background: rgba(255,255,255,0.96); border-radius: 8px; padding: .75rem 1rem; display:flex; align-items:center; gap:.6rem; box-shadow:0 6px 18px rgba(0,0,0,0.08); }
.spinner { width:18px; height:18px; border:3px solid rgba(0,0,0,0.08); border-top-color:#2563eb; border-radius:50%; animation: spin .9s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.search-input { padding:.5rem .9rem; border-radius:8px; border:1px solid #e5e7eb; width:240px; transition: box-shadow .12s ease; }
.search-input:focus { outline:none; box-shadow:0 6px 18px rgba(37,99,235,0.12); border-color:#3b82f6; }
.status { padding:.2rem .5rem; border-radius:999px; font-size:0.85rem; display:inline-block; }
.status.pending { background:#fff7ed; color:#92400e; }
.status.delivered { background:#ecfdf5; color:#065f46; }
.status.cancelled { background:#fff1f2; color:#7f1d1d; }
table tr { transition: background .12s ease, transform .12s ease; }
.notification-toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 1rem;
      border-radius: 8px;
      background: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 50;
    }
    .notification-toast.error { background: #fee2e2; color: #991b1b; }
    .notification-toast.success { background: #dcfce7; color: #166534; }
</style>

<!-- ===== Scripts ===== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const dashboard = {
        elements: {
            // ...existing elements...
        },
        
        async fetchDashboardData() {
            try {
                const [metricsResponse, dataResponse] = await Promise.all([
                    fetch('/api/dashboard/metrics/'),
                    fetch('/api/dashboard/data/')
                ]);

                const metrics = await metricsResponse.json();
                const data = await dataResponse.json();

                if (metrics.status === 'success' && data.status === 'success') {
                    this.updateDashboard(metrics.data, data.data);
                }
            } catch (error) {
                console.error('Failed to fetch dashboard data:', error);
                this.showNotification('Failed to update dashboard', 'error');
            }
        },

        updateDashboard(metrics, data) {
            // Update metrics
            document.getElementById('totalOrders').textContent = metrics.total_orders;
            document.getElementById('totalRevenue').textContent = '₹' + metrics.total_revenue.toFixed(2);
            document.getElementById('pendingOrders').textContent = metrics.pending_orders;
            document.getElementById('deliveredOrders').textContent = metrics.delivered_orders;

            // Update orders table
            const tbody = document.querySelector('#ordersTable tbody');
            tbody.innerHTML = data.orders.map(order => `
                <tr>
                    <td>${order.id}</td>
                    <td>${order.email.split('@')[0]}</td>
                    <td>${order.item}</td>
                    <td>₹${(order.price * order.qty).toFixed(2)}</td>
                    <td><span class="status ${order.status.toLowerCase()}">${order.status}</span></td>
                    <td>${new Date(order.created_at).toLocaleString()}</td>
                </tr>
            `).join('');

            // Update top products
            const productsList = document.getElementById('topProducts');
            productsList.innerHTML = data.top_products.map(product => `
                <li>${product.name} — <span class="font-semibold">${product.sales} sold</span></li>
            `).join('');

            // Update feedback
            const feedbackList = document.getElementById('feedbackList');
            feedbackList.innerHTML = data.feedback.map(fb => `
                <li>
                    <p class="italic">"${fb.message}"</p>
                    <small class="text-gray-500">- ${fb.name} (${new Date(fb.created_at).toLocaleDateString()})</small>
                </li>
            `).join('');

            // Update user activity
            const userActivity = document.getElementById('userActivity');
            document.getElementById('onlineUsers').textContent = data.active_users.length;
            userActivity.innerHTML = data.active_users.map(user => `
                <li>
                    ${user.username} 
                    <span class="text-green-600 font-semibold ml-2">(online)</span>
                    <span class="text-gray-500">(${this.timeAgo(new Date(user.last_login))})</span>
                </li>
            `).join('');

            // Update chart if we have chart data
            if (metrics.chart_data) {
                this.initChart(metrics.chart_data);
            }
        },

        timeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            const intervals = {
                year: 31536000,
                month: 2592000,
                week: 604800,
                day: 86400,
                hour: 3600,
                minute: 60,
                second: 1
            };
            for (let [unit, secondsInUnit] of Object.entries(intervals)) {
                const interval = Math.floor(seconds / secondsInUnit);
                if (interval > 1) {
                    return `${interval} ${unit}s ago`;
                } else if (interval === 1) {
                    return `1 ${unit} ago`;
                }
            }
            return 'just now';
        },

        startAutoRefresh() {
            setInterval(() => this.fetchDashboardData(), 30000); // Refresh every 30 seconds
        },

        init() {
            this.fetchDashboardData();
            this.startAutoRefresh();
            this.setupEventListeners();
        }
    };

    dashboard.init();
});
</script>
{% endblock %}
